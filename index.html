<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="L∆∞·ª£ng gi√° - Kh·∫£o s√°t">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="·ª®ng d·ª•ng l∆∞·ª£ng gi√° v√† kh·∫£o s√°t - Ph√≤ng QLCL BV Nhi ƒë·ªìng TP. C·∫ßn Th∆°">
    <title>L∆∞·ª£ng gi√° - Kh·∫£o s√°t | BV Nhi ƒë·ªìng C·∫ßn Th∆°</title>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }

        .btn-qlcl {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
        }

        .btn-tyc {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
        }

        .star-btn {
            transition: transform 0.15s;
        }

        .star-btn:hover {
            transform: scale(1.2);
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast {
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s;
        }

        @keyframes toastIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .card-hover {
            transition: all 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .safe-top {
            padding-top: env(safe-area-inset-top, 0px);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <i class="fas fa-spinner spinner text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500">ƒêang t·∫£i ·ª©ng d·ª•ng...</p>
            </div>
        </div>
    </div>

    <script>
        // ===================== FIREBASE CONFIG =====================
        // ‚ö†Ô∏è THAY ƒê·ªîI C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N T·∫†I ƒê√ÇY
        const firebaseConfig = {
            apiKey: "AIzaSyBNIsKl8KHl0-CpwZn-R504uAKvFN6A8AQ",
            authDomain: "ks-checklist-bvnhidong.firebaseapp.com",
            databaseURL: "https://ks-checklist-bvnhidong-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ks-checklist-bvnhidong",
            storageBucket: "ks-checklist-bvnhidong.firebasestorage.app",
            messagingSenderId: "1073910974970",
            appId: "1:1073910974970:web:a9a0f9c360918226357c43"
        };

        // ===================== DEFAULT ADMIN =====================
        const DEFAULT_ADMIN = {
            username: 'admin',
            password: 'admin@123',
            name: 'Qu·∫£n tr·ªã vi√™n',
            role: 'admin'
        };

        // Initialize Firebase
        let db;
        let firebaseReady = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                firebaseReady = true;
            }
        } catch (error) {
            console.error('Firebase init error:', error);
        }

        // ===================== DEFAULT INFO FIELDS =====================
        const DEFAULT_INFO_FIELDS = [
            { id: 'customerName', label: 'T√™n kh√°ch h√†ng', type: 'text', required: true },
            { id: 'clinic', label: 'Ph√≤ng kh√°m', type: 'select', options: 'clinics', required: true },
            { id: 'doctorName', label: 'B√°c sƒ©', type: 'text', required: false },
            { id: 'surveyorName', label: 'Ng∆∞·ªùi kh·∫£o s√°t', type: 'text', required: true }
        ];

        const LUONG_GIA_INFO_FIELDS = [
            { id: 'department', label: 'Khoa/Ph√≤ng ki·ªÉm tra', type: 'text', required: true },
            { id: 'targetPerson', label: 'Ng∆∞·ªùi ƒë∆∞·ª£c gi√°m s√°t', type: 'text', required: true },
            { id: 'supervisorName', label: 'Ng∆∞·ªùi gi√°m s√°t', type: 'text', required: true },
            { id: 'checkDate', label: 'Ng√†y ki·ªÉm tra', type: 'date', required: true }
        ];

        const LUONG_GIA_CATEGORIES = [
            { id: 'quy_trinh', name: 'Quy tr√¨nh', icon: 'üìã' },
            { id: '5s', name: '5S', icon: 'üè•' },
            { id: 'scyk', name: 'SCYK', icon: '‚ö†Ô∏è' },
            { id: 'khac', name: 'Kh√°c', icon: 'üìù' }
        ];

        // ===================== APP STATE =====================
        const APP = {
            currentUser: null,
            currentModule: 'home',
            activeSubsystem: 'QLCL',
            currentSurvey: null,
            notification: null,
            loading: false,
            editingQuestionSet: null,
            users: [],
            questionSets: [],
            surveys: [],
            clinics: [],
            config: { telegramBotToken: '', telegramChatId: '', hospitalName: 'B·ªánh vi·ªán Nhi ƒë·ªìng TP. C·∫ßn Th∆°' },
            filterDate: { from: '', to: '' },
            selectedQuestionSet: null,
            homeFilter: 'all' // all, survey, luong_gia, luong_gia_quy_trinh, luong_gia_5s, luong_gia_scyk, luong_gia_khac
        };

        // ===================== UTILITY =====================
        const showNotification = (msg, type = 'success') => {
            APP.notification = { message: msg, type };
            render();
            setTimeout(() => { APP.notification = null; render(); }, 3000);
        };

        const showLoading = (show = true) => { APP.loading = show; render(); };

        const hasNegativeFeedback = (s) => s.answers?.some(a => a.type === 'rating' && a.value <= 2);

        const formatDate = (ts) => {
            if (!ts) return '';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return d.toLocaleString('vi-VN');
        };

        const hashPassword = (str) => {
            let h = 0;
            for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h = h & h; }
            return 'h' + Math.abs(h).toString(16);
        };

        // ===================== AUTH =====================
        const initializeAdmin = async () => {
            try {
                const snap = await db.ref('users/admin').once('value');
                if (!snap.exists()) {
                    await db.ref('users/admin').set({
                        username: DEFAULT_ADMIN.username,
                        password: hashPassword(DEFAULT_ADMIN.password),
                        name: DEFAULT_ADMIN.name,
                        role: DEFAULT_ADMIN.role,
                        createdAt: Date.now()
                    });
                }
            } catch (e) { console.error('Init admin:', e); }
        };

        const login = async (username, password) => {
            try {
                showLoading(true);
                const snap = await db.ref('users').orderByChild('username').equalTo(username.toLowerCase().trim()).once('value');
                if (!snap.exists()) { showNotification('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!', 'error'); return false; }
                let userData, odId;
                snap.forEach(child => { odId = child.key; userData = child.val(); });
                if (userData.password !== hashPassword(password)) { showNotification('Sai m·∫≠t kh·∫©u!', 'error'); return false; }
                APP.currentUser = { id: odId, ...userData };
                APP.activeSubsystem = userData.role === 'admin' ? 'QLCL' : userData.role.toUpperCase();
                localStorage.setItem('survey_session', JSON.stringify({ odId, username: userData.username }));
                await loadAllData();
                showNotification(`Xin ch√†o, ${userData.name}!`);
                return true;
            } catch (e) { showNotification('L·ªói ƒëƒÉng nh·∫≠p!', 'error'); return false; }
            finally { showLoading(false); }
        };

        const checkSession = async () => {
            try {
                const s = localStorage.getItem('survey_session');
                if (!s) return false;
                const { odId } = JSON.parse(s);
                const snap = await db.ref('users/' + odId).once('value');
                if (!snap.exists()) { localStorage.removeItem('survey_session'); return false; }
                APP.currentUser = { id: odId, ...snap.val() };
                APP.activeSubsystem = APP.currentUser.role === 'admin' ? 'QLCL' : APP.currentUser.role.toUpperCase();
                return true;
            } catch (e) { return false; }
        };

        const logout = () => {
            APP.currentUser = null;
            APP.currentModule = 'home';
            localStorage.removeItem('survey_session');
            showNotification('ƒê√£ ƒëƒÉng xu·∫•t!');
            render();
        };

        // ===================== USER MANAGEMENT =====================
        const createUser = async (username, password, name, role) => {
            try {
                showLoading(true);
                const snap = await db.ref('users').orderByChild('username').equalTo(username.toLowerCase().trim()).once('value');
                if (snap.exists()) { showNotification('T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!', 'error'); return false; }
                const id = username.toLowerCase().trim() + '_' + Date.now();
                await db.ref('users/' + id).set({
                    username: username.toLowerCase().trim(),
                    password: hashPassword(password),
                    name: name.trim(),
                    role,
                    createdAt: Date.now(),
                    createdBy: APP.currentUser.id
                });
                await loadUsers();
                showNotification('T·∫°o t√†i kho·∫£n th√†nh c√¥ng!');
                return true;
            } catch (e) { showNotification('L·ªói t·∫°o t√†i kho·∫£n!', 'error'); return false; }
            finally { showLoading(false); }
        };

        const deleteUser = async (id) => {
            if (id === 'admin') { showNotification('Kh√¥ng th·ªÉ x√≥a admin g·ªëc!', 'error'); return; }
            try {
                await db.ref('users/' + id).remove();
                await loadUsers();
                showNotification('ƒê√£ x√≥a!');
            } catch (e) { showNotification('L·ªói!', 'error'); }
        };

        const changePassword = async (id, newPwd) => {
            try {
                await db.ref('users/' + id).update({ password: hashPassword(newPwd) });
                showNotification('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u!');
            } catch (e) { showNotification('L·ªói!', 'error'); }
        };

        // ===================== DATA LOADING =====================
        const loadAllData = async () => {
            await Promise.all([loadConfig(), loadUsers(), loadClinics(), loadQuestionSets(), loadSurveys()]);
        };

        const loadConfig = async () => {
            try {
                const snap = await db.ref('settings/config').once('value');
                if (snap.exists()) APP.config = { ...APP.config, ...snap.val() };
            } catch (e) { }
        };

        const saveConfig = async () => {
            try {
                await db.ref('settings/config').set(APP.config);
                showNotification('ƒê√£ l∆∞u!');
            } catch (e) { showNotification('L·ªói!', 'error'); }
        };

        const loadUsers = async () => {
            try {
                const snap = await db.ref('users').once('value');
                APP.users = [];
                snap.forEach(child => { APP.users.push({ id: child.key, ...child.val() }); });
                APP.users.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            } catch (e) { }
        };

        const loadClinics = async () => {
            try {
                const snap = await db.ref('clinics').once('value');
                APP.clinics = [];
                snap.forEach(child => { APP.clinics.push({ id: child.key, ...child.val() }); });
                APP.clinics.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                if (APP.clinics.length === 0 && APP.currentUser?.role === 'admin') {
                    const defs = ['Ph√≤ng kh√°m Nhi t·ªïng qu√°t', 'Ph√≤ng kh√°m Tai M≈©i H·ªçng', 'Ph√≤ng kh√°m M·∫Øt', 'Ph√≤ng kh√°m Da li·ªÖu', 'Ph√≤ng kh√°m Tim m·∫°ch', 'Ph√≤ng kh√°m H√¥ h·∫•p', 'Ph√≤ng kh√°m Ti√™u h√≥a', 'Ph√≤ng kh√°m Th·∫ßn kinh', 'Ph√≤ng kh√°m C·∫•p c·ª©u'];
                    for (const n of defs) await db.ref('clinics').push({ name: n });
                    await loadClinics();
                }
            } catch (e) { }
        };

        const loadQuestionSets = async () => {
            try {
                const snap = await db.ref('questionSets').once('value');
                APP.questionSets = [];
                snap.forEach(child => { APP.questionSets.push({ id: child.key, ...child.val() }); });
                APP.questionSets.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                if (APP.questionSets.length === 0 && APP.currentUser?.role === 'admin') {
                    await createDefaultQuestionSets();
                    await loadQuestionSets();
                }
            } catch (e) { }
        };

        const createDefaultQuestionSets = async () => {
            const defs = {
                QLCL: {
                    name: 'B·ªô c√¢u h·ªèi QLCL m·∫∑c ƒë·ªãnh',
                    type: 'survey',
                    infoFields: JSON.parse(JSON.stringify(DEFAULT_INFO_FIELDS)),
                    questions: [
                        { id: 1, text: 'Th√°i ƒë·ªô ph·ª•c v·ª• c·ªßa nh√¢n vi√™n y t·∫ø', type: 'rating', required: true },
                        { id: 2, text: 'Th·ªùi gian ch·ªù ƒë·ª£i kh√°m b·ªánh', type: 'rating', required: true },
                        { id: 3, text: 'C∆° s·ªü v·∫≠t ch·∫•t, trang thi·∫øt b·ªã', type: 'rating', required: true },
                        { id: 4, text: 'H∆∞·ªõng d·∫´n quy tr√¨nh kh√°m ch·ªØa b·ªánh', type: 'rating', required: true },
                        { id: 5, text: 'M·ª©c ƒë·ªô h√†i l√≤ng chung', type: 'rating', required: true },
                        { id: 6, text: 'G√≥p √Ω, ƒë·ªÅ xu·∫•t kh√°c', type: 'text', required: false }
                    ]
                },
                TYC: {
                    name: 'B·ªô c√¢u h·ªèi TYC m·∫∑c ƒë·ªãnh',
                    type: 'survey',
                    infoFields: JSON.parse(JSON.stringify(DEFAULT_INFO_FIELDS)),
                    questions: [
                        { id: 1, text: 'Quy tr√¨nh ƒëƒÉng k√Ω kh√°m c√≥ thu·∫≠n ti·ªán kh√¥ng?', type: 'rating', required: true },
                        { id: 2, text: 'Th√°i ƒë·ªô c·ªßa nh√¢n vi√™n ti·∫øp ƒë√≥n', type: 'rating', required: true },
                        { id: 3, text: 'B√°c sƒ© gi·∫£i th√≠ch t√¨nh tr·∫°ng b·ªánh r√µ r√†ng kh√¥ng?', type: 'rating', required: true },
                        { id: 4, text: 'Th·ªùi gian kh√°m c√≥ ph√π h·ª£p kh√¥ng?', type: 'rating', required: true },
                        { id: 5, text: 'B·∫°n c√≥ gi·ªõi thi·ªáu ng∆∞·ªùi th√¢n ƒë·∫øn kh√°m kh√¥ng?', type: 'yesno', required: true },
                        { id: 6, text: '√ù ki·∫øn ƒë√≥ng g√≥p', type: 'text', required: false }
                    ]
                }
            };
            for (const [sub, data] of Object.entries(defs)) {
                await db.ref('questionSets').push({ ...data, subsystem: sub, isDefault: true, createdAt: Date.now() });
            }
        };

        const loadSurveys = async () => {
            try {
                const snap = await db.ref('surveys').limitToLast(500).once('value');
                APP.surveys = [];
                snap.forEach(child => { APP.surveys.push({ id: child.key, ...child.val() }); });
                APP.surveys.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            } catch (e) { }
        };

        const createQuestionSet = async (name, subsystem, questions) => {
            try {
                showLoading(true);
                await db.ref('questionSets').push({ name, subsystem, questions, isDefault: false, createdAt: Date.now() });
                await loadQuestionSets();
                showNotification('ƒê√£ t·∫°o!');
                return true;
            } catch (e) { showNotification('L·ªói!', 'error'); return false; }
            finally { showLoading(false); }
        };

        const updateQuestionSet = async (id, data) => {
            try {
                await db.ref('questionSets/' + id).update(data);
                await loadQuestionSets();
                showNotification('ƒê√£ c·∫≠p nh·∫≠t!');
            } catch (e) { showNotification('L·ªói!', 'error'); }
        };

        const deleteQuestionSet = async (id) => {
            try {
                await db.ref('questionSets/' + id).remove();
                await loadQuestionSets();
                showNotification('ƒê√£ x√≥a!');
            } catch (e) { showNotification('L·ªói!', 'error'); }
        };

        const saveSurvey = async (survey) => {
            try {
                showLoading(true);
                const newRef = await db.ref('surveys').push({ ...survey, timestamp: Date.now(), createdBy: APP.currentUser.id });
                survey.id = newRef.key;
                await loadSurveys();
                return survey;
            } catch (e) { showNotification('L·ªói!', 'error'); return null; }
            finally { showLoading(false); }
        };

        const addClinic = async (name) => { try { await db.ref('clinics').push({ name }); await loadClinics(); showNotification('ƒê√£ th√™m!'); } catch (e) { showNotification('L·ªói!', 'error'); } };
        const updateClinic = async (id, name) => { try { await db.ref('clinics/' + id).update({ name }); await loadClinics(); } catch (e) { } };
        const deleteClinic = async (id) => { try { await db.ref('clinics/' + id).remove(); await loadClinics(); showNotification('ƒê√£ x√≥a!'); } catch (e) { } };

        // ===================== TELEGRAM =====================
        const sendTelegramAlert = async (survey) => {
            if (!APP.config.telegramBotToken || !APP.config.telegramChatId) { showNotification('Ch∆∞a c·∫•u h√¨nh Telegram!', 'error'); return false; }
            const low = survey.answers.filter(a => a.type === 'rating' && a.value <= 2);
            const txt = survey.answers.find(a => a.type === 'text' && a.value);
            const msg = `üö® *C·∫¢NH B√ÅO PH·∫¢N H·ªíI KH√îNG T·ªêT*\n\nüìã *Ph√¢n h·ªá:* ${survey.subsystem === 'QLCL' ? 'Ph√≤ng QLCL' : 'BQL Kh√°m TYC'}\nüìù *B·ªô c√¢u h·ªèi:* ${survey.questionSetName || 'M·∫∑c ƒë·ªãnh'}\nüë§ *Kh√°ch h√†ng:* ${survey.customerName}\nüè• *Ph√≤ng kh√°m:* ${survey.clinic}\nüë®‚Äç‚öïÔ∏è *B√°c sƒ©:* ${survey.doctorName || 'Kh√¥ng c√≥'}\nüìù *Ng∆∞·ªùi kh·∫£o s√°t:* ${survey.surveyorName}\nüïê *Th·ªùi gian:* ${new Date().toLocaleString('vi-VN')}\n\n‚ö†Ô∏è *C√°c m·ª•c ƒë√°nh gi√° th·∫•p:*\n${low.map(r => `‚Ä¢ ${r.question}: ${r.value}/5 ‚≠ê`).join('\n')}${txt ? `\n\nüí¨ *G√≥p √Ω:* ${txt.value}` : ''}`;
            try {
                const res = await fetch(`https://api.telegram.org/bot${APP.config.telegramBotToken}/sendMessage`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: APP.config.telegramChatId, text: msg, parse_mode: 'Markdown' })
                });
                if (res.ok) {
                    showNotification('ƒê√£ g·ª≠i c·∫£nh b√°o!');
                    if (survey.id) await db.ref('surveys/' + survey.id).update({ telegramSent: true });
                    return true;
                }
                throw new Error();
            } catch (e) { showNotification('L·ªói g·ª≠i Telegram!', 'error'); return false; }
        };

        // ===================== EXPORT =====================
        const exportToCSV = () => {
            const filtered = getFilteredSurveys();
            if (filtered.length === 0) { showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu!', 'error'); return; }
            const allQ = new Set();
            filtered.forEach(s => s.answers?.forEach(a => allQ.add(a.question)));
            const headers = ['STT', 'Ph√¢n h·ªá', 'B·ªô c√¢u h·ªèi', 'Kh√°ch h√†ng', 'Ph√≤ng kh√°m', 'B√°c sƒ©', 'Ng∆∞·ªùi kh·∫£o s√°t', 'Th·ªùi gian', ...Array.from(allQ), 'ƒê√£ b√°o c√°o'];
            const rows = filtered.map((s, i) => {
                const v = {};
                s.answers?.forEach(a => v[a.question] = a.type === 'rating' ? `${a.value}/5` : (a.value || ''));
                return [i + 1, s.subsystem, s.questionSetName || '', s.customerName, s.clinic, s.doctorName || '', s.surveyorName, formatDate(s.timestamp), ...Array.from(allQ).map(q => v[q] || ''), s.telegramSent ? 'C√≥' : 'Kh√¥ng'];
            });
            const csv = '\uFEFF' + [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `KhaoSat_${APP.activeSubsystem}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            showNotification('ƒê√£ xu·∫•t file CSV!');
        };

        const exportToReport = () => {
            const filtered = getFilteredSurveys();
            if (filtered.length === 0) { showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu!', 'error'); return; }
            const stats = getStatistics();
            const qsName = APP.selectedQuestionSet ? APP.questionSets.find(q => q.id === APP.selectedQuestionSet)?.name : 'T·∫•t c·∫£ b·ªô c√¢u h·ªèi';
            const allQ = new Set();
            filtered.forEach(s => s.answers?.forEach(a => allQ.add(a.question)));
            const today = new Date().toLocaleDateString('vi-VN');

            const html = `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o c√°o kh·∫£o s√°t - ${APP.config.hospitalName}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5; padding: 20mm; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .header h2 { font-size: 13pt; font-weight: bold; margin-bottom: 10px; }
        .header p { font-size: 12pt; }
        .info { margin-bottom: 15px; }
        .info p { margin: 3px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 11pt; }
        th, td { border: 1px solid #000; padding: 5px 8px; text-align: left; }
        th { background: #f0f0f0; font-weight: bold; text-align: center; }
        td { vertical-align: top; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .stats { margin: 15px 0; }
        .stats-grid { display: flex; gap: 20px; margin: 10px 0; }
        .stats-item { padding: 10px; border: 1px solid #ccc; flex: 1; text-align: center; }
        .footer { margin-top: 30px; display: flex; justify-content: space-between; }
        .signature { text-align: center; width: 45%; }
        .signature p { margin: 5px 0; }
        @media print { body { padding: 10mm; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>${APP.config.hospitalName}</h1>
        <h2>B√ÅO C√ÅO KH·∫¢O S√ÅT KH√ÅCH H√ÄNG</h2>
        <p><strong>B·ªô c√¢u h·ªèi:</strong> ${qsName}</p>
        <p><strong>Ph√¢n h·ªá:</strong> ${APP.activeSubsystem === 'QLCL' ? 'Ph√≤ng Qu·∫£n l√Ω Ch·∫•t l∆∞·ª£ng' : 'Ban Qu·∫£n l√Ω Kh√°m theo y√™u c·∫ßu'}</p>
    </div>
    
    <div class="info">
        <p><strong>Ng√†y xu·∫•t b√°o c√°o:</strong> ${today}</p>
        <p><strong>Th·ªùi gian kh·∫£o s√°t:</strong> ${APP.filterDate.from ? new Date(APP.filterDate.from).toLocaleDateString('vi-VN') : 'Kh√¥ng gi·ªõi h·∫°n'} - ${APP.filterDate.to ? new Date(APP.filterDate.to).toLocaleDateString('vi-VN') : 'ƒê·∫øn nay'}</p>
    </div>
    
    <div class="stats">
        <p><strong>TH·ªêNG K√ä T·ªîNG QUAN:</strong></p>
        <table>
            <tr><th>T·ªïng s·ªë phi·∫øu</th><th>Ph·∫£n h·ªìi kh√¥ng t·ªët</th><th>T·ª∑ l·ªá h√†i l√≤ng</th></tr>
            <tr>
                <td class="text-center">${stats?.total || 0}</td>
                <td class="text-center">${stats?.negative || 0}</td>
                <td class="text-center">${stats?.total ? ((1 - stats.negative / stats.total) * 100).toFixed(1) : 0}%</td>
            </tr>
        </table>
        ${stats && Object.keys(stats.avgRatings).length > 0 ? `
        <p><strong>ƒêI·ªÇM TRUNG B√åNH THEO TI√äU CH√ç:</strong></p>
        <table>
            <tr><th style="width:70%">Ti√™u ch√≠</th><th>ƒêi·ªÉm TB (thang 5)</th></tr>
            ${Object.entries(stats.avgRatings).map(([k, v]) => `<tr><td>${k}</td><td class="text-center">${v}</td></tr>`).join('')}
        </table>` : ''}
    </div>
    
    <p><strong>CHI TI·∫æT C√ÅC PHI·∫æU KH·∫¢O S√ÅT:</strong></p>
    <table>
        <tr>
            <th style="width:30px">STT</th>
            <th>Kh√°ch h√†ng</th>
            <th>Ph√≤ng kh√°m</th>
            <th>B√°c sƒ©</th>
            <th>Ng∆∞·ªùi KS</th>
            <th>Th·ªùi gian</th>
            ${Array.from(allQ).map(q => `<th>${q}</th>`).join('')}
        </tr>
        ${filtered.map((s, i) => {
                const v = {};
                s.answers?.forEach(a => v[a.question] = a.type === 'rating' ? `${a.value}/5` : (a.value || '-'));
                return `<tr>
                <td class="text-center">${i + 1}</td>
                <td>${s.customerName}</td>
                <td>${s.clinic}</td>
                <td>${s.doctorName || '-'}</td>
                <td>${s.surveyorName}</td>
                <td>${formatDate(s.timestamp)}</td>
                ${Array.from(allQ).map(q => `<td class="text-center">${v[q] || '-'}</td>`).join('')}
            </tr>`;
            }).join('')}
    </table>
    
    <div class="footer">
        <div class="signature">
            <p><strong>Ng∆∞·ªùi l·∫≠p b√°o c√°o</strong></p>
            <p style="margin-top: 50px;">${APP.currentUser?.name || ''}</p>
        </div>
        <div class="signature">
            <p><strong>X√°c nh·∫≠n c·ªßa l√£nh ƒë·∫°o</strong></p>
            <p style="margin-top: 50px;">...........................</p>
        </div>
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `BaoCao_KhaoSat_${APP.activeSubsystem}_${new Date().toISOString().slice(0, 10)}.html`;
            link.click();
            showNotification('ƒê√£ xu·∫•t b√°o c√°o! M·ªü file v√† in (Ctrl+P) ƒë·ªÉ l∆∞u PDF.');
        };

        // ===================== HELPERS =====================
        const getFilteredSurveys = () => APP.surveys.filter(s => {
            if (s.subsystem !== APP.activeSubsystem) return false;
            if (APP.selectedQuestionSet && s.questionSetId !== APP.selectedQuestionSet) return false;
            if (APP.filterDate.from) { const d = s.timestamp?.toDate ? s.timestamp.toDate() : new Date(s.timestamp); if (d < new Date(APP.filterDate.from)) return false; }
            if (APP.filterDate.to) { const d = s.timestamp?.toDate ? s.timestamp.toDate() : new Date(s.timestamp); if (d > new Date(APP.filterDate.to + 'T23:59:59')) return false; }
            return true;
        });

        const getStatistics = () => {
            const f = getFilteredSurveys();
            if (f.length === 0) return null;
            const stats = { total: f.length, negative: f.filter(hasNegativeFeedback).length, avgRatings: {} };
            const rq = {};
            f.forEach(s => s.answers?.filter(a => a.type === 'rating').forEach(a => { if (!rq[a.question]) rq[a.question] = []; if (a.value > 0) rq[a.question].push(a.value); }));
            for (const [q, v] of Object.entries(rq)) stats.avgRatings[q] = v.length > 0 ? (v.reduce((a, b) => a + b, 0) / v.length).toFixed(2) : 0;
            return stats;
        };

        const getSubsystemQuestionSets = () => APP.questionSets.filter(qs => qs.subsystem === APP.activeSubsystem);

        // ===================== ACTIONS =====================
        window.startNewSurvey = (qsId) => {
            const qs = APP.questionSets.find(q => q.id === qsId);
            if (!qs) { showNotification('Kh√¥ng t√¨m th·∫•y!', 'error'); return; }
            const infoFields = qs.infoFields || DEFAULT_INFO_FIELDS;
            const infoData = {};
            infoFields.forEach(f => { infoData[f.id] = f.type === 'date' ? '' : ''; });
            APP.currentSurvey = {
                subsystem: APP.activeSubsystem, questionSetId: qs.id, questionSetName: qs.name,
                infoData,
                answers: qs.questions.map(q => ({ questionId: q.id, question: q.text, type: q.type, value: q.type === 'rating' ? 0 : '' })),
                telegramSent: false
            };
            APP.currentModule = 'survey';
            render();
        };

        window.submitSurvey = async () => {
            const s = APP.currentSurvey;
            const qs = APP.questionSets.find(q => q.id === s.questionSetId);
            const infoFields = qs?.infoFields || DEFAULT_INFO_FIELDS;
            const missingInfo = infoFields.filter(f => f.required && !s.infoData?.[f.id]);
            if (missingInfo.length > 0) { showNotification(`ƒêi·ªÅn ƒë·∫ßy ƒë·ªß: ${missingInfo.map(f => f.label).join(', ')}!`, 'error'); return; }
            const req = qs?.questions.filter(q => q.required) || [];
            const un = req.filter(q => { const a = s.answers.find(a => a.questionId === q.id); return !a?.value || a.value === 0; });
            if (un.length > 0) { showNotification('Tr·∫£ l·ªùi t·∫•t c·∫£ c√¢u h·ªèi b·∫Øt bu·ªôc!', 'error'); return; }
            if (qs?.type === 'luong_gia' && !s.conclusion) { showNotification('Vui l√≤ng ch·ªçn k·∫øt lu·∫≠n!', 'error'); return; }
            const saved = await saveSurvey(s);
            if (saved) {
                APP.currentSurvey = saved;
                showNotification('ƒê√£ l∆∞u phi·∫øu th√†nh c√¥ng!');
                render();
            }
        };

        window.handleTelegramSend = async () => { await sendTelegramAlert(APP.currentSurvey); APP.currentSurvey = null; APP.currentModule = 'home'; render(); };
        window.setRating = (qId, v) => { const a = APP.currentSurvey.answers.find(a => a.questionId === qId); if (a) a.value = v; render(); };
        window.setYesNo = (qId, v) => { const a = APP.currentSurvey.answers.find(a => a.questionId === qId); if (a) a.value = v; render(); };
        window.setTextAnswer = (qId, v) => { const a = APP.currentSurvey.answers.find(a => a.questionId === qId); if (a) a.value = v; };
        window.setInfoField = (fieldId, value) => { if (!APP.currentSurvey.infoData) APP.currentSurvey.infoData = {}; APP.currentSurvey.infoData[fieldId] = value; };
        window.setAnswerNote = (qId, note) => { const a = APP.currentSurvey.answers.find(a => a.questionId === qId); if (a) a.note = note; };

        window.sendTelegramById = async (surveyId) => {
            const survey = APP.surveys.find(s => s.id === surveyId);
            if (!survey) { showNotification('Kh√¥ng t√¨m th·∫•y phi·∫øu!', 'error'); return; }
            const ok = await sendTelegramAlert(survey);
            if (ok) { await loadSurveys(); render(); }
        };

        // ===================== RENDERS =====================
        const renderStars = (v, qId) => {
            const l = ['R·∫•t kh√¥ng h√†i l√≤ng', 'Kh√¥ng h√†i l√≤ng', 'B√¨nh th∆∞·ªùng', 'H√†i l√≤ng', 'R·∫•t h√†i l√≤ng'];
            return `<div class="flex flex-col items-center gap-2"><div class="flex gap-1">${[1, 2, 3, 4, 5].map(i => `<button type="button" onclick="setRating(${qId}, ${i})" class="star-btn text-3xl ${i <= v ? 'text-yellow-400' : 'text-gray-300'} hover:text-yellow-400">${i <= v ? '‚òÖ' : '‚òÜ'}</button>`).join('')}</div>${v > 0 ? `<span class="text-sm font-medium ${v <= 2 ? 'text-red-500' : v === 3 ? 'text-yellow-600' : 'text-green-500'}">${l[v - 1]}</span>` : ''}</div>`;
        };

        const renderYesNo = (v, qId) => `<div class="flex gap-4 justify-center"><button type="button" onclick="setYesNo(${qId}, 'yes')" class="px-6 py-3 rounded-xl font-medium transition-all ${v === 'yes' ? 'bg-green-500 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 hover:bg-green-100'}"><i class="fas fa-check mr-2"></i>C√≥</button><button type="button" onclick="setYesNo(${qId}, 'no')" class="px-6 py-3 rounded-xl font-medium transition-all ${v === 'no' ? 'bg-red-500 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 hover:bg-red-100'}"><i class="fas fa-times mr-2"></i>Kh√¥ng</button></div>`;

        const renderLogin = () => `
            <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-500 to-purple-600">
                <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md slide-up">
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"><i class="fas fa-hospital text-white text-3xl"></i></div>
                        <h1 class="text-2xl font-bold text-gray-800">L∆∞·ª£ng gi√° - Kh·∫£o s√°t</h1>
                        <p class="text-gray-500">${APP.config.hospitalName}</p>
                        <p class="text-sm text-gray-400 mt-1">Ph√≤ng Qu·∫£n l√Ω Ch·∫•t l∆∞·ª£ng</p>
                        <p class="text-xs text-gray-400">T√°c gi·∫£: BS. Ki·ªÅu Vi·ªát Ti·∫øn H∆∞ng</p>
                    </div>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="loginUsername" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p..." class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></div>
                        <div><label class="block text-sm font-medium text-gray-600 mb-1">M·∫≠t kh·∫©u</label><div class="relative"><input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..." onkeypress="if(event.key==='Enter') handleLogin();" class="w-full p-3 border border-gray-200 rounded-xl pr-10"><button type="button" onclick="togglePwd('loginPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-eye"></i></button></div></div>
                        <button onclick="handleLogin()" class="w-full py-4 btn-primary text-white rounded-xl font-bold text-lg hover:shadow-lg"><i class="fas fa-sign-in-alt mr-2"></i>ƒêƒÉng nh·∫≠p</button>
                    </div>
                    <div class="mt-6 p-4 bg-amber-50 rounded-xl border border-amber-200"><p class="text-sm text-amber-700 text-center"><i class="fas fa-info-circle mr-1"></i><strong>T√†i kho·∫£n m·∫∑c ƒë·ªãnh:</strong><br>Username: <code class="bg-amber-100 px-1 rounded">admin</code> | Password: <code class="bg-amber-100 px-1 rounded">admin@123</code></p></div>
                </div>
            </div>
        `;

        window.togglePwd = (id) => { const i = document.getElementById(id); const ic = i.nextElementSibling.querySelector('i'); if (i.type === 'password') { i.type = 'text'; ic.className = 'fas fa-eye-slash'; } else { i.type = 'password'; ic.className = 'fas fa-eye'; } };
        window.handleLogin = async () => { const u = document.getElementById('loginUsername').value; const p = document.getElementById('loginPassword').value; if (!u || !p) { showNotification('Nh·∫≠p ƒë·∫ßy ƒë·ªß!', 'error'); return; } await login(u, p); render(); };

        const renderHome = () => {
            const svs = APP.surveys.filter(s => s.subsystem === APP.activeSubsystem);
            const neg = svs.filter(hasNegativeFeedback);
            const allQSets = getSubsystemQuestionSets();

            // Filter question sets based on homeFilter
            let filteredQSets = allQSets;
            if (APP.homeFilter === 'survey') {
                filteredQSets = allQSets.filter(qs => qs.type !== 'luong_gia');
            } else if (APP.homeFilter === 'luong_gia') {
                filteredQSets = allQSets.filter(qs => qs.type === 'luong_gia');
            } else if (APP.homeFilter.startsWith('luong_gia_')) {
                const cat = APP.homeFilter.replace('luong_gia_', '');
                filteredQSets = allQSets.filter(qs => qs.type === 'luong_gia' && qs.luongGiaCategory === cat);
            }

            const getQsLabel = (qs) => {
                if (qs.type === 'luong_gia') {
                    const cat = LUONG_GIA_CATEGORIES.find(c => c.id === qs.luongGiaCategory);
                    return cat ? `${cat.icon} ${cat.name}` : 'üìä L∆∞·ª£ng gi√°';
                }
                return 'üìã Kh·∫£o s√°t';
            };

            return `<div class="space-y-4 slide-up"><div class="grid grid-cols-2 gap-3"><div class="bg-white rounded-2xl shadow-lg p-4 text-center card-hover"><div class="text-3xl font-bold text-blue-600">${svs.length}</div><div class="text-sm text-gray-500">T·ªïng phi·∫øu</div></div><div class="bg-white rounded-2xl shadow-lg p-4 text-center card-hover"><div class="text-3xl font-bold text-red-600">${neg.length}</div><div class="text-sm text-gray-500">Ph·∫£n h·ªìi x·∫•u</div></div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-clipboard-list ${APP.activeSubsystem === 'QLCL' ? 'text-blue-500' : 'text-purple-500'}"></i>Ch·ªçn b·ªô c√¢u h·ªèi</h3><select onchange="APP.homeFilter = this.value; render();" class="w-full p-2 border border-gray-200 rounded-xl mb-3 text-sm"><option value="all" ${APP.homeFilter === 'all' ? 'selected' : ''}>üìÅ T·∫•t c·∫£</option><option value="survey" ${APP.homeFilter === 'survey' ? 'selected' : ''}>üìã Kh·∫£o s√°t</option><option value="luong_gia" ${APP.homeFilter === 'luong_gia' ? 'selected' : ''}>üìä L∆∞·ª£ng gi√° (t·∫•t c·∫£)</option>${LUONG_GIA_CATEGORIES.map(c => `<option value="luong_gia_${c.id}" ${APP.homeFilter === 'luong_gia_' + c.id ? 'selected' : ''}>&nbsp;&nbsp;&nbsp;${c.icon} ${c.name}</option>`).join('')}</select>${filteredQSets.length === 0 ? `<div class="text-center py-8 text-gray-400"><i class="fas fa-folder-open text-4xl mb-2 opacity-50"></i><p>Ch∆∞a c√≥ b·ªô c√¢u h·ªèi</p></div>` : `<div class="space-y-3">${filteredQSets.map(qs => `<div class="p-4 bg-gradient-to-r ${APP.activeSubsystem === 'QLCL' ? 'from-blue-50 to-cyan-50 border-blue-200' : 'from-purple-50 to-pink-50 border-purple-200'} border rounded-xl card-hover"><div class="flex items-center justify-between"><div><h4 class="font-semibold text-gray-800">${qs.name}</h4><p class="text-sm text-gray-500">${qs.questions?.length || 0} ${qs.type === 'luong_gia' ? 'n·ªôi dung' : 'c√¢u h·ªèi'} ‚Ä¢ ${getQsLabel(qs)}</p></div><button onclick="startNewSurvey('${qs.id}')" class="px-4 py-2 ${APP.activeSubsystem === 'QLCL' ? 'btn-qlcl' : 'btn-tyc'} text-white rounded-xl font-medium hover:shadow-lg"><i class="fas fa-play mr-1"></i>${qs.type === 'luong_gia' ? 'B·∫Øt ƒë·∫ßu' : 'Kh·∫£o s√°t'}</button></div></div>`).join('')}</div>`}</div>${svs.length > 0 ? `<div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-history text-green-500"></i>G·∫ßn ƒë√¢y</h3><div class="space-y-2 max-h-48 overflow-y-auto">${svs.slice(0, 5).map(s => `<div class="p-3 rounded-xl ${hasNegativeFeedback(s) ? 'bg-red-50 border border-red-200' : 'bg-gray-50'}"><div class="flex justify-between items-start"><div><div class="font-medium text-gray-800">${s.infoData?.customerName || s.infoData?.department || s.customerName || 'N/A'}</div><div class="text-xs text-gray-500">${s.infoData?.clinic || s.infoData?.supervisorName || s.clinic || ''}</div></div><div class="text-xs text-gray-400">${formatDate(s.timestamp)}</div></div></div>`).join('')}</div></div>` : ''}</div>`;
        };

        const renderSurveyForm = () => {
            const s = APP.currentSurvey;
            const isSaved = !!s.id;
            const qs = APP.questionSets.find(q => q.id === s.questionSetId);
            const infoFields = qs?.infoFields || DEFAULT_INFO_FIELDS;
            const isLuongGia = qs?.type === 'luong_gia';
            const luongGiaCat = LUONG_GIA_CATEGORIES.find(c => c.id === qs?.luongGiaCategory);
            const typeLabel = isLuongGia ? `L∆∞·ª£ng gi√°${luongGiaCat ? ' - ' + luongGiaCat.name : ''}` : 'Kh·∫£o s√°t';

            const renderInfoField = (field) => {
                const val = s.infoData?.[field.id] || '';
                const reqMark = field.required ? '<span class="text-red-500">*</span>' : '';

                if (field.type === 'select' && field.options === 'clinics') {
                    return `<div><label class="block text-sm font-medium text-gray-600 mb-1">${field.label} ${reqMark}</label><select onchange="setInfoField('${field.id}', this.value)" class="w-full p-3 border border-gray-200 rounded-xl"><option value="">-- Ch·ªçn --</option>${APP.clinics.map(c => `<option value="${c.name}" ${val === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div>`;
                } else if (field.type === 'date') {
                    return `<div><label class="block text-sm font-medium text-gray-600 mb-1">${field.label} ${reqMark}</label><input type="date" value="${val}" onchange="setInfoField('${field.id}', this.value)" class="w-full p-3 border border-gray-200 rounded-xl"></div>`;
                } else if (field.type === 'number') {
                    return `<div><label class="block text-sm font-medium text-gray-600 mb-1">${field.label} ${reqMark}</label><input type="number" value="${val}" onchange="setInfoField('${field.id}', this.value)" placeholder="Nh·∫≠p s·ªë..." class="w-full p-3 border border-gray-200 rounded-xl"></div>`;
                } else {
                    return `<div><label class="block text-sm font-medium text-gray-600 mb-1">${field.label} ${reqMark}</label><input type="text" value="${val}" onchange="setInfoField('${field.id}', this.value)" placeholder="Nh·∫≠p..." class="w-full p-3 border border-gray-200 rounded-xl"></div>`;
                }
            };

            const renderQuestionWithNote = (q, i, a) => {
                const noteVal = a?.note || '';
                return `<div class="pb-4 border-b border-gray-100 last:border-0">
                    <p class="font-medium text-gray-800 mb-3"><span class="inline-flex items-center justify-center w-6 h-6 ${APP.activeSubsystem === 'QLCL' ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'} rounded-full text-sm mr-2">${i + 1}</span>${q.text}${q.required ? '<span class="text-red-500 ml-1">*</span>' : ''}</p>
                    ${q.type === 'rating' ? renderStars(a?.value || 0, q.id) : ''}
                    ${q.type === 'yesno' ? renderYesNo(a?.value || '', q.id) : ''}
                    ${q.type === 'text' ? `<textarea onchange="setTextAnswer(${q.id}, this.value)" placeholder="Nh·∫≠p √Ω ki·∫øn..." class="w-full p-3 border border-gray-200 rounded-xl" rows="3">${a?.value || ''}</textarea>` : ''}
                    ${isLuongGia ? `<div class="mt-2"><input type="text" value="${noteVal}" onchange="setAnswerNote(${q.id}, this.value)" placeholder="Ghi ch√∫..." class="w-full p-2 border border-gray-200 rounded-lg text-sm bg-gray-50"></div>` : ''}
                </div>`;
            };

            const conclusionOptions = ['ƒê·∫°t', 'Kh√¥ng ƒë·∫°t', 'C·∫ßn c·∫£i thi·ªán', 'T·ªët', 'Xu·∫•t s·∫Øc'];
            const conclusionVal = s.conclusion || '';

            return `<div class="space-y-4 slide-up"><div class="bg-gradient-to-r ${APP.activeSubsystem === 'QLCL' ? 'from-blue-500 to-cyan-500' : 'from-purple-500 to-pink-500'} rounded-2xl p-4 text-white"><h3 class="font-bold text-lg">${qs?.name || typeLabel}</h3><p class="text-sm opacity-90">${APP.activeSubsystem === 'QLCL' ? 'Ph√≤ng QLCL' : 'BQL Kh√°m TYC'} ‚Ä¢ ${typeLabel}</p></div><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-info-circle text-blue-500"></i>Th√¥ng tin</h3><div class="space-y-3">${infoFields.map(f => renderInfoField(f)).join('')}</div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-clipboard-list text-green-500"></i>${isLuongGia ? 'N·ªôi dung l∆∞·ª£ng gi√°' : 'C√¢u h·ªèi'}</h3><div class="space-y-6">${qs?.questions.map((q, i) => { const a = s.answers.find(a => a.questionId === q.id); return renderQuestionWithNote(q, i, a); }).join('')}</div></div>${isLuongGia ? `<div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-clipboard-check text-purple-500"></i>K·∫øt lu·∫≠n <span class="text-red-500">*</span></h3><div class="space-y-3"><select onchange="APP.currentSurvey.conclusion = this.value;" class="w-full p-3 border border-gray-200 rounded-xl"><option value="">-- Ch·ªçn k·∫øt lu·∫≠n --</option>${conclusionOptions.map(opt => `<option value="${opt}" ${conclusionVal === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select><textarea onchange="APP.currentSurvey.conclusionNote = this.value;" placeholder="Ghi ch√∫ k·∫øt lu·∫≠n (n·∫øu c√≥)..." class="w-full p-3 border border-gray-200 rounded-xl" rows="2">${s.conclusionNote || ''}</textarea></div></div>` : ''}${!isSaved ? `<div class="flex gap-3"><button onclick="APP.currentSurvey = null; APP.currentModule = 'home'; render();" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200">H·ªßy</button><button onclick="submitSurvey()" class="flex-1 py-3 ${APP.activeSubsystem === 'QLCL' ? 'btn-qlcl' : 'btn-tyc'} text-white rounded-xl font-medium hover:shadow-lg flex items-center justify-center gap-2"><i class="fas fa-save"></i>L∆∞u</button></div>` : `<div class="bg-green-50 border border-green-200 rounded-2xl p-4"><div class="flex items-center gap-3 mb-3"><i class="fas fa-check-circle text-green-500 text-xl"></i><span class="font-bold text-green-700">ƒê√£ l∆∞u phi·∫øu th√†nh c√¥ng!</span></div><p class="text-gray-600 text-sm mb-3">B·∫°n c√≥ mu·ªën g·ª≠i th√¥ng tin qua Telegram kh√¥ng?</p><button onclick="handleTelegramSend()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-medium hover:bg-blue-600 flex items-center justify-center gap-2"><i class="fab fa-telegram"></i>G·ª≠i qua Telegram</button><button onclick="APP.currentSurvey = null; APP.currentModule = 'home'; render();" class="w-full py-2 mt-2 text-gray-500 text-sm hover:text-gray-700">B·ªè qua, v·ªÅ trang ch·ªß</button></div>`}</div>`;
        };

        const renderResults = () => {
            const stats = getStatistics();
            const filtered = getFilteredSurveys();
            const qSets = getSubsystemQuestionSets();
            const getInfoDisplay = (s) => {
                const d = s.infoData || {};
                const name = d.customerName || d.department || d.targetPerson || s.customerName || 'N/A';
                const sub = d.clinic || d.supervisorName || s.clinic || '';
                return { name, sub };
            };
            const getConclusionBadge = (c) => {
                if (!c) return '';
                const colors = { 'ƒê·∫°t': 'bg-green-100 text-green-700', 'Kh√¥ng ƒë·∫°t': 'bg-red-100 text-red-700', 'C·∫ßn c·∫£i thi·ªán': 'bg-yellow-100 text-yellow-700', 'T·ªët': 'bg-blue-100 text-blue-700', 'Xu·∫•t s·∫Øc': 'bg-purple-100 text-purple-700' };
                return `<span class="text-xs px-2 py-0.5 rounded-full ${colors[c] || 'bg-gray-100 text-gray-700'}">${c}</span>`;
            };
            const conclusionStats = {};
            filtered.forEach(s => { if (s.conclusion) { conclusionStats[s.conclusion] = (conclusionStats[s.conclusion] || 0) + 1; } });
            return `<div class="space-y-4 slide-up"><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-filter text-blue-500"></i>B·ªô l·ªçc</h3><div class="space-y-3"><select onchange="APP.selectedQuestionSet = this.value || null; render();" class="w-full p-2 border border-gray-200 rounded-xl"><option value="">T·∫•t c·∫£</option>${qSets.map(qs => `<option value="${qs.id}" ${APP.selectedQuestionSet === qs.id ? 'selected' : ''}>${qs.name}</option>`).join('')}</select><div class="flex flex-wrap gap-3"><div class="flex-1 min-w-32"><label class="block text-xs text-gray-500 mb-1">T·ª´ ng√†y</label><input type="date" value="${APP.filterDate.from}" onchange="APP.filterDate.from = this.value; render();" class="w-full p-2 border border-gray-200 rounded-xl"></div><div class="flex-1 min-w-32"><label class="block text-xs text-gray-500 mb-1">ƒê·∫øn ng√†y</label><input type="date" value="${APP.filterDate.to}" onchange="APP.filterDate.to = this.value; render();" class="w-full p-2 border border-gray-200 rounded-xl"></div><button onclick="APP.filterDate = {from: '', to: ''}; APP.selectedQuestionSet = null; render();" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl self-end hover:bg-gray-200">X√≥a</button></div></div></div>${stats ? `<div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-chart-bar text-green-500"></i>Th·ªëng k√™</h3><div class="grid grid-cols-2 gap-3 mb-4"><div class="bg-blue-50 rounded-xl p-3 text-center"><div class="text-2xl font-bold text-blue-600">${stats.total}</div><div class="text-xs text-blue-600">T·ªïng</div></div><div class="bg-red-50 rounded-xl p-3 text-center"><div class="text-2xl font-bold text-red-600">${stats.negative}</div><div class="text-xs text-red-600">X·∫•u</div></div></div>${Object.keys(conclusionStats).length > 0 ? `<div class="mb-3"><h4 class="font-medium text-gray-700 text-sm mb-2">K·∫øt lu·∫≠n:</h4><div class="flex flex-wrap gap-2">${Object.entries(conclusionStats).map(([k, v]) => `<span class="text-xs px-3 py-1 rounded-full ${k === 'ƒê·∫°t' || k === 'T·ªët' || k === 'Xu·∫•t s·∫Øc' ? 'bg-green-100 text-green-700' : k === 'Kh√¥ng ƒë·∫°t' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${k}: ${v}</span>`).join('')}</div></div>` : ''}${Object.keys(stats.avgRatings).length > 0 ? `<div class="space-y-2"><h4 class="font-medium text-gray-700 text-sm">ƒêi·ªÉm TB:</h4>${Object.entries(stats.avgRatings).map(([k, v]) => `<div class="flex items-center gap-2"><div class="flex-1 text-sm text-gray-600 truncate">${k}</div><span class="font-bold ${v >= 4 ? 'text-green-600' : v >= 3 ? 'text-yellow-600' : 'text-red-600'}">${v}</span><span class="text-yellow-500">‚≠ê</span><div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full ${v >= 4 ? 'bg-green-500' : v >= 3 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${(v / 5) * 100}%"></div></div></div>`).join('')}</div>` : ''}</div>` : ''}<div class="bg-white rounded-2xl shadow-lg p-4"><div class="flex items-center justify-between mb-3 flex-wrap gap-2"><h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-list text-purple-500"></i>Danh s√°ch (${filtered.length})</h3><div class="flex gap-2"><button onclick="exportToReport()" class="px-3 py-2 bg-blue-500 text-white rounded-xl text-sm flex items-center gap-1 hover:bg-blue-600"><i class="fas fa-file-alt"></i>B√°o c√°o</button><button onclick="exportToCSV()" class="px-3 py-2 bg-green-500 text-white rounded-xl text-sm flex items-center gap-1 hover:bg-green-600"><i class="fas fa-download"></i>CSV</button></div></div>${filtered.length === 0 ? `<div class="text-center py-8 text-gray-400"><i class="fas fa-clipboard-list text-4xl mb-2 opacity-50"></i><p>Ch∆∞a c√≥</p></div>` : `<div class="space-y-2 max-h-96 overflow-y-auto">${filtered.map(s => { const info = getInfoDisplay(s); return `<div class="p-3 rounded-xl border ${hasNegativeFeedback(s) ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-100'}"><div class="flex items-start justify-between"><div><div class="font-medium text-gray-800">${info.name}</div><div class="text-sm text-gray-500">${info.sub}</div><div class="text-xs text-gray-400 mt-1">${s.questionSetName || ''} ‚Ä¢ ${formatDate(s.timestamp)}</div></div><div class="flex flex-col items-end gap-1">${s.conclusion ? getConclusionBadge(s.conclusion) : ''}${!s.telegramSent ? `<button onclick="sendTelegramById('${s.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 flex items-center gap-1"><i class="fab fa-telegram"></i>G·ª≠i TG</button>` : '<span class="text-xs px-2 py-1 bg-green-100 text-green-600 rounded-full"><i class="fas fa-check"></i> ƒê√£ g·ª≠i</span>'}${hasNegativeFeedback(s) ? '<span class="text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full mt-1"><i class="fas fa-exclamation-triangle"></i></span>' : ''}</div></div><div class="mt-2 flex flex-wrap gap-1">${s.answers?.filter(a => a.type === 'rating').map(a => `<span class="text-xs px-2 py-0.5 rounded-full ${a.value <= 2 ? 'bg-red-100 text-red-700' : a.value === 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${a.value}‚≠ê</span>`).join('')}</div></div>`; }).join('')}</div>`}</div></div>`;
        };

        const renderQuestions = () => {
            const qSets = getSubsystemQuestionSets();
            return `<div class="space-y-4 slide-up"><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-plus text-blue-500"></i>T·∫°o b·ªô m·ªõi</h3><div class="space-y-3"><input type="text" id="newSetName" placeholder="T√™n b·ªô c√¢u h·ªèi..." class="w-full p-3 border border-gray-200 rounded-xl"><button onclick="createNewQS()" class="w-full py-3 ${APP.activeSubsystem === 'QLCL' ? 'btn-qlcl' : 'btn-tyc'} text-white rounded-xl font-medium"><i class="fas fa-plus mr-2"></i>T·∫°o</button></div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3">Danh s√°ch (${qSets.length})</h3>${qSets.length === 0 ? `<div class="text-center py-8 text-gray-400"><i class="fas fa-folder-open text-4xl mb-2 opacity-50"></i><p>Ch∆∞a c√≥</p></div>` : `<div class="space-y-3">${qSets.map(qs => `<div class="border border-gray-200 rounded-xl overflow-hidden"><div class="p-4 bg-gray-50 flex items-center justify-between"><div><h4 class="font-semibold text-gray-800">${qs.name}</h4><p class="text-sm text-gray-500">${qs.questions?.length || 0} c√¢u h·ªèi</p></div><div class="flex gap-2"><button onclick="editQS('${qs.id}')" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg"><i class="fas fa-edit"></i></button>${!qs.isDefault ? `<button onclick="delQS('${qs.id}')" class="p-2 text-red-500 hover:bg-red-100 rounded-lg"><i class="fas fa-trash"></i></button>` : ''}</div></div><div class="p-3 space-y-2 max-h-40 overflow-y-auto">${qs.questions?.map((q, i) => `<div class="flex items-center gap-2 text-sm"><span class="w-5 h-5 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs">${i + 1}</span><span class="flex-1 text-gray-700 truncate">${q.text}</span><span class="text-xs px-2 py-0.5 rounded-full ${q.type === 'rating' ? 'bg-yellow-100 text-yellow-700' : q.type === 'yesno' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${q.type === 'rating' ? '‚≠ê' : q.type === 'yesno' ? '‚úì‚úó' : 'üìù'}</span></div>`).join('')}</div></div>`).join('')}</div>`}</div></div>`;
        };

        window.createNewQS = async () => { const n = document.getElementById('newSetName').value.trim(); if (!n) { showNotification('Nh·∫≠p t√™n!', 'error'); return; } const ok = await createQuestionSet(n, APP.activeSubsystem, [{ id: 1, text: 'C√¢u h·ªèi m·∫´u', type: 'rating', required: true }]); if (ok) { document.getElementById('newSetName').value = ''; render(); } };
        window.editQS = (id) => { APP.editingQuestionSet = JSON.parse(JSON.stringify(APP.questionSets.find(qs => qs.id === id))); APP.currentModule = 'editQuestions'; render(); };
        window.delQS = (id) => { if (confirm('X√≥a?')) deleteQuestionSet(id); };

        const renderEditQuestions = () => {
            const qs = APP.editingQuestionSet;
            if (!qs) { APP.currentModule = 'questions'; render(); return ''; }
            if (!qs.infoFields) qs.infoFields = JSON.parse(JSON.stringify(DEFAULT_INFO_FIELDS));
            if (!qs.type) qs.type = 'survey';
            const isLuongGia = qs.type === 'luong_gia';
            return `<div class="space-y-4 slide-up"><div class="bg-white rounded-2xl shadow-lg p-4"><div class="flex items-center justify-between mb-4"><h3 class="font-bold text-gray-800">Ch·ªânh s·ª≠a</h3><button onclick="APP.currentModule = 'questions'; APP.editingQuestionSet = null; render();" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button></div><input type="text" id="editSetName" value="${qs.name}" class="w-full p-3 border border-gray-200 rounded-xl mb-3"><select id="editSetType" class="w-full p-3 border border-gray-200 rounded-xl mb-3" onchange="APP.editingQuestionSet.type = this.value; if(this.value !== 'luong_gia') APP.editingQuestionSet.luongGiaCategory = null; render();"><option value="survey" ${qs.type === 'survey' ? 'selected' : ''}>üìã Kh·∫£o s√°t</option><option value="luong_gia" ${qs.type === 'luong_gia' ? 'selected' : ''}>üìä L∆∞·ª£ng gi√°</option></select>${isLuongGia ? `<select class="w-full p-3 border border-gray-200 rounded-xl mb-3" onchange="APP.editingQuestionSet.luongGiaCategory = this.value; render();"><option value="">-- Ch·ªçn ph√¢n lo·∫°i --</option>${LUONG_GIA_CATEGORIES.map(c => `<option value="${c.id}" ${qs.luongGiaCategory === c.id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('')}</select>` : ''}</div><div class="bg-white rounded-2xl shadow-lg p-4"><h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-info-circle text-blue-500"></i>Tr∆∞·ªùng th√¥ng tin (${qs.infoFields?.length || 0})</h4><div class="space-y-2 mb-3">${qs.infoFields?.map((f, i) => `<div class="p-3 bg-gray-50 rounded-xl flex items-center gap-2"><input type="text" value="${f.label}" onchange="APP.editingQuestionSet.infoFields[${i}].label = this.value;" class="flex-1 p-2 border border-gray-200 rounded-lg text-sm" placeholder="T√™n tr∆∞·ªùng"><select onchange="APP.editingQuestionSet.infoFields[${i}].type = this.value;" class="p-2 border border-gray-200 rounded-lg text-sm"><option value="text" ${f.type === 'text' ? 'selected' : ''}>Ch·ªØ</option><option value="date" ${f.type === 'date' ? 'selected' : ''}>Ng√†y</option><option value="number" ${f.type === 'number' ? 'selected' : ''}>S·ªë</option><option value="select" ${f.type === 'select' ? 'selected' : ''}>Ch·ªçn PK</option></select><label class="flex items-center gap-1 text-sm"><input type="checkbox" ${f.required ? 'checked' : ''} onchange="APP.editingQuestionSet.infoFields[${i}].required = this.checked;" class="w-4 h-4">B·∫Øt bu·ªôc</label><button onclick="rmInfoField(${i})" class="p-2 text-red-500 hover:bg-red-100 rounded-lg"><i class="fas fa-trash"></i></button></div>`).join('')}</div><div class="flex gap-2"><button onclick="addInfoField()" class="flex-1 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-500 hover:text-blue-500 text-sm"><i class="fas fa-plus mr-1"></i>Th√™m tr∆∞·ªùng</button><button onclick="resetInfoFields()" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-xl text-sm hover:bg-gray-200">Reset m·∫∑c ƒë·ªãnh</button></div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h4 class="font-semibold text-gray-800 mb-3">Th√™m ${isLuongGia ? 'n·ªôi dung' : 'c√¢u h·ªèi'}</h4><div class="space-y-3"><textarea id="newQText" placeholder="N·ªôi dung..." class="w-full p-3 border border-gray-200 rounded-xl" rows="2"></textarea><div class="flex flex-wrap gap-3"><select id="newQType" class="flex-1 min-w-32 p-2 border border-gray-200 rounded-xl"><option value="rating">‚≠ê Sao</option><option value="yesno">‚úì‚úó C√≥/Kh√¥ng</option><option value="text">üìù VƒÉn b·∫£n</option></select><label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-xl"><input type="checkbox" id="newQReq" checked class="w-4 h-4"><span class="text-sm">B·∫Øt bu·ªôc</span></label><button onclick="addQToSet()" class="px-4 py-2 bg-blue-500 text-white rounded-xl"><i class="fas fa-plus"></i></button></div></div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h4 class="font-semibold text-gray-800 mb-3">${isLuongGia ? 'N·ªôi dung' : 'C√¢u h·ªèi'} (${qs.questions?.length || 0})</h4><div class="space-y-2">${qs.questions?.map((q, i) => `<div class="p-3 bg-gray-50 rounded-xl"><div class="flex items-start gap-3 mb-2"><span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${i + 1}</span><textarea onchange="editQText(${q.id}, this.value)" class="flex-1 p-2 border border-gray-200 rounded-lg text-sm" rows="2">${q.text}</textarea><button onclick="rmQFromSet(${q.id})" class="p-2 text-red-500 hover:bg-red-100 rounded-lg flex-shrink-0"><i class="fas fa-trash"></i></button></div><div class="flex items-center gap-3 ml-9"><select onchange="editQType(${q.id}, this.value)" class="p-2 border border-gray-200 rounded-lg text-sm"><option value="rating" ${q.type === 'rating' ? 'selected' : ''}>‚≠ê Sao</option><option value="yesno" ${q.type === 'yesno' ? 'selected' : ''}>‚úì‚úó C√≥/Kh√¥ng</option><option value="text" ${q.type === 'text' ? 'selected' : ''}>üìù VƒÉn b·∫£n</option></select><label class="flex items-center gap-1 text-sm"><input type="checkbox" ${q.required ? 'checked' : ''} onchange="editQReq(${q.id}, this.checked)" class="w-4 h-4">B·∫Øt bu·ªôc</label></div></div>`).join('')}</div></div><button onclick="saveQSChanges()" class="w-full py-3 btn-primary text-white rounded-xl font-medium"><i class="fas fa-save mr-2"></i>L∆∞u</button></div>`;
        };

        window.addInfoField = () => { const maxId = 'field_' + Date.now(); APP.editingQuestionSet.infoFields.push({ id: maxId, label: 'Tr∆∞·ªùng m·ªõi', type: 'text', required: false }); render(); };
        window.rmInfoField = (i) => { if (APP.editingQuestionSet.infoFields.length <= 1) { showNotification('C·∫ßn √≠t nh·∫•t 1 tr∆∞·ªùng!', 'error'); return; } APP.editingQuestionSet.infoFields.splice(i, 1); render(); };
        window.resetInfoFields = () => { APP.editingQuestionSet.infoFields = JSON.parse(JSON.stringify(DEFAULT_INFO_FIELDS)); render(); };

        window.addQToSet = () => { const t = document.getElementById('newQText').value.trim(); if (!t) { showNotification('Nh·∫≠p n·ªôi dung!', 'error'); return; } const maxId = Math.max(0, ...APP.editingQuestionSet.questions.map(q => q.id)); APP.editingQuestionSet.questions.push({ id: maxId + 1, text: t, type: document.getElementById('newQType').value, required: document.getElementById('newQReq').checked }); document.getElementById('newQText').value = ''; render(); };
        window.rmQFromSet = (id) => { if (APP.editingQuestionSet.questions.length <= 1) { showNotification('C·∫ßn √≠t nh·∫•t 1!', 'error'); return; } APP.editingQuestionSet.questions = APP.editingQuestionSet.questions.filter(q => q.id !== id); render(); };
        window.editQText = (id, text) => { const q = APP.editingQuestionSet.questions.find(q => q.id === id); if (q) q.text = text; };
        window.editQType = (id, type) => { const q = APP.editingQuestionSet.questions.find(q => q.id === id); if (q) q.type = type; };
        window.editQReq = (id, req) => { const q = APP.editingQuestionSet.questions.find(q => q.id === id); if (q) q.required = req; };
        window.saveQSChanges = async () => { const n = document.getElementById('editSetName').value.trim(); if (!n) { showNotification('Nh·∫≠p t√™n!', 'error'); return; } const qs = APP.editingQuestionSet; await updateQuestionSet(qs.id, { name: n, type: qs.type, luongGiaCategory: qs.luongGiaCategory || null, infoFields: qs.infoFields, questions: qs.questions }); APP.editingQuestionSet = null; APP.currentModule = 'questions'; render(); };

        const renderUsers = () => `<div class="space-y-4 slide-up"><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-user-plus text-blue-500"></i>T·∫°o t√†i kho·∫£n</h3><div class="space-y-3"><input type="text" id="newUName" placeholder="H·ªç t√™n..." class="w-full p-3 border border-gray-200 rounded-xl"><input type="text" id="newUUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p..." class="w-full p-3 border border-gray-200 rounded-xl"><div class="relative"><input type="password" id="newUPwd" placeholder="M·∫≠t kh·∫©u..." class="w-full p-3 border border-gray-200 rounded-xl pr-10"><button type="button" onclick="togglePwd('newUPwd')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-eye"></i></button></div><select id="newURole" class="w-full p-3 border border-gray-200 rounded-xl"><option value="">-- Ch·ªçn quy·ªÅn --</option><option value="admin">üëë Admin</option><option value="qlcl">üìã Ph√≤ng QLCL</option><option value="tyc">ü©∫ BQL Kh√°m TYC</option></select><button onclick="handleCreateU()" class="w-full py-3 btn-primary text-white rounded-xl font-medium"><i class="fas fa-plus mr-2"></i>T·∫°o</button></div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3">Danh s√°ch (${APP.users.length})</h3><div class="space-y-2">${APP.users.map(u => `<div class="p-3 bg-gray-50 rounded-xl"><div class="flex items-center justify-between"><div><div class="font-medium text-gray-800">${u.name}</div><div class="text-sm text-gray-500">@${u.username}</div><span class="text-xs px-2 py-0.5 rounded-full ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : u.role === 'qlcl' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}">${u.role === 'admin' ? 'üëë Admin' : u.role === 'qlcl' ? 'üìã QLCL' : 'ü©∫ TYC'}</span></div><div class="flex gap-1"><button onclick="changePwdModal('${u.id}')" class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg" title="ƒê·ªïi m·∫≠t kh·∫©u"><i class="fas fa-key"></i></button>${u.id !== 'admin' && u.id !== APP.currentUser.id ? `<button onclick="delU('${u.id}')" class="p-2 text-red-500 hover:bg-red-100 rounded-lg"><i class="fas fa-trash"></i></button>` : ''}</div></div></div>`).join('')}</div></div></div>`;

        window.handleCreateU = async () => { const n = document.getElementById('newUName').value.trim(); const u = document.getElementById('newUUsername').value.trim(); const p = document.getElementById('newUPwd').value; const r = document.getElementById('newURole').value; if (!n || !u || !p || !r) { showNotification('ƒêi·ªÅn ƒë·∫ßy ƒë·ªß!', 'error'); return; } if (p.length < 6) { showNotification('M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±!', 'error'); return; } const ok = await createUser(u, p, n, r); if (ok) { document.getElementById('newUName').value = ''; document.getElementById('newUUsername').value = ''; document.getElementById('newUPwd').value = ''; document.getElementById('newURole').value = ''; render(); } };
        window.delU = (id) => { if (confirm('X√≥a?')) deleteUser(id); };
        window.changePwdModal = (id) => { const p = prompt('M·∫≠t kh·∫©u m·ªõi (min 6 k√Ω t·ª±):'); if (p) { if (p.length < 6) { showNotification('T·ªëi thi·ªÉu 6 k√Ω t·ª±!', 'error'); return; } changePassword(id, p); } };

        const renderSettings = () => `<div class="space-y-4 slide-up"><div class="bg-white rounded-2xl shadow-lg p-4"><div class="flex items-center gap-4"><div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center"><i class="fas fa-user text-white text-2xl"></i></div><div><div class="font-bold text-gray-800">${APP.currentUser?.name}</div><div class="text-sm text-gray-500">@${APP.currentUser?.username}</div><span class="text-xs px-2 py-1 rounded-full ${APP.currentUser?.role === 'admin' ? 'bg-purple-100 text-purple-700' : APP.currentUser?.role === 'qlcl' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}">${APP.currentUser?.role === 'admin' ? 'üëë Admin' : APP.currentUser?.role === 'qlcl' ? 'üìã QLCL' : 'ü©∫ TYC'}</span></div></div></div>${APP.currentUser?.role === 'admin' ? `<div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fab fa-telegram text-blue-500"></i>Telegram</h3><div class="space-y-3"><div><label class="block text-sm font-medium text-gray-600 mb-1">Bot Token</label><input type="text" id="tgToken" value="${APP.config.telegramBotToken}" placeholder="Bot Token..." class="w-full p-3 border border-gray-200 rounded-xl font-mono text-sm"></div><div><label class="block text-sm font-medium text-gray-600 mb-1">Chat ID</label><input type="text" id="tgChatId" value="${APP.config.telegramChatId}" placeholder="Chat ID..." class="w-full p-3 border border-gray-200 rounded-xl font-mono text-sm"></div><button onclick="saveTgConfig()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-medium"><i class="fas fa-save mr-2"></i>L∆∞u</button></div></div><div class="bg-white rounded-2xl shadow-lg p-4"><h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-hospital text-green-500"></i>Ph√≤ng kh√°m (${APP.clinics.length})</h3><div class="space-y-2 max-h-48 overflow-y-auto mb-3">${APP.clinics.map(c => `<div class="flex items-center gap-2"><input type="text" value="${c.name}" onchange="updClinic('${c.id}', this.value)" class="flex-1 p-2 border border-gray-200 rounded-xl"><button onclick="delClinic('${c.id}')" class="p-2 text-red-500 hover:bg-red-100 rounded-xl"><i class="fas fa-trash"></i></button></div>`).join('')}</div><button onclick="addClinicBtn()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-500 hover:text-blue-500"><i class="fas fa-plus mr-2"></i>Th√™m</button></div>` : ''}<button onclick="changePwdModal('${APP.currentUser?.id}')" class="w-full py-3 bg-blue-100 text-blue-600 rounded-xl font-medium hover:bg-blue-200"><i class="fas fa-key mr-2"></i>ƒê·ªïi m·∫≠t kh·∫©u</button><button onclick="logout()" class="w-full py-3 bg-red-100 text-red-600 rounded-xl font-medium hover:bg-red-200"><i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t</button><div class="text-center text-gray-400 text-sm py-4"><p class="font-semibold">L∆∞·ª£ng gi√° - Kh·∫£o s√°t v2.0</p><p>${APP.config.hospitalName}</p><p class="text-xs mt-1">Ph√≤ng Qu·∫£n l√Ω Ch·∫•t l∆∞·ª£ng</p><p class="text-xs">T√°c gi·∫£: BS. Ki·ªÅu Vi·ªát Ti·∫øn H∆∞ng</p></div></div>`;

        window.saveTgConfig = async () => { APP.config.telegramBotToken = document.getElementById('tgToken').value; APP.config.telegramChatId = document.getElementById('tgChatId').value; await saveConfig(); };
        window.addClinicBtn = () => addClinic('Ph√≤ng kh√°m m·ªõi');
        window.updClinic = (id, n) => updateClinic(id, n);
        window.delClinic = (id) => { if (APP.clinics.length <= 1) { showNotification('C·∫ßn √≠t nh·∫•t 1!', 'error'); return; } if (confirm('X√≥a?')) deleteClinic(id); };

        // ===================== MAIN RENDER =====================
        const render = () => {
            if (!APP.currentUser) { document.getElementById('app').innerHTML = renderLogin(); return; }
            let content = '';
            switch (APP.currentModule) {
                case 'home': content = renderHome(); break;
                case 'survey': content = renderSurveyForm(); break;
                case 'results': content = renderResults(); break;
                case 'questions': content = renderQuestions(); break;
                case 'editQuestions': content = renderEditQuestions(); break;
                case 'users': content = renderUsers(); break;
                case 'settings': content = renderSettings(); break;
            }
            const navItems = [{ id: 'home', icon: 'fa-home', label: 'Trang ch·ªß' }, { id: 'results', icon: 'fa-chart-bar', label: 'B√°o c√°o' }, { id: 'questions', icon: 'fa-clipboard-list', label: 'C√¢u h·ªèi' }];
            if (APP.currentUser.role === 'admin') navItems.push({ id: 'users', icon: 'fa-users', label: 'T√†i kho·∫£n' });
            navItems.push({ id: 'settings', icon: 'fa-cog', label: 'C√†i ƒë·∫∑t' });

            document.getElementById('app').innerHTML = `
                <div class="bg-gradient-to-r ${APP.activeSubsystem === 'QLCL' ? 'from-blue-600 to-cyan-600' : 'from-purple-600 to-pink-600'} text-white p-4 shadow-lg sticky top-0 z-40 safe-top"><div class="max-w-lg mx-auto"><h1 class="text-lg font-bold text-center">üè• L∆∞·ª£ng gi√° - Kh·∫£o s√°t</h1><p class="text-center text-white/80 text-sm">${APP.config.hospitalName}</p><p class="text-center text-white/60 text-xs">Ph√≤ng Qu·∫£n l√Ω Ch·∫•t l∆∞·ª£ng</p></div></div>
                ${APP.currentUser.role === 'admin' ? `<div class="max-w-lg mx-auto px-4 pt-4"><div class="bg-white rounded-2xl shadow-lg p-1 flex gap-1"><button onclick="APP.activeSubsystem = 'QLCL'; APP.selectedQuestionSet = null; render();" class="flex-1 py-3 rounded-xl font-medium transition-all ${APP.activeSubsystem === 'QLCL' ? 'btn-qlcl text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">üìã Ph√≤ng QLCL</button><button onclick="APP.activeSubsystem = 'TYC'; APP.selectedQuestionSet = null; render();" class="flex-1 py-3 rounded-xl font-medium transition-all ${APP.activeSubsystem === 'TYC' ? 'btn-tyc text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">ü©∫ BQL Kh√°m TYC</button></div></div>` : `<div class="max-w-lg mx-auto px-4 pt-4"><div class="bg-white rounded-2xl shadow-lg p-3 text-center"><span class="font-bold ${APP.activeSubsystem === 'QLCL' ? 'text-blue-600' : 'text-purple-600'}">${APP.activeSubsystem === 'QLCL' ? 'üìã Ph√≤ng QLCL' : 'ü©∫ BQL Kh√°m TYC'}</span></div></div>`}
                <div class="max-w-lg mx-auto px-4 py-4 pb-24">${content}<div class="text-center text-gray-400 text-xs py-4 mt-4 border-t border-gray-100">T√°c gi·∫£: BS. Ki·ªÅu Vi·ªát Ti·∫øn H∆∞ng</div></div>
                <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40 safe-bottom"><div class="max-w-lg mx-auto flex">${navItems.map(item => `<button onclick="APP.currentModule = '${item.id}'; render();" class="flex-1 py-3 flex flex-col items-center gap-1 transition-colors ${APP.currentModule === item.id || (item.id === 'questions' && APP.currentModule === 'editQuestions') ? (APP.activeSubsystem === 'QLCL' ? 'text-blue-600 bg-blue-50' : 'text-purple-600 bg-purple-50') : 'text-gray-500 hover:text-gray-700'}"><i class="fas ${item.icon} text-xl"></i><span class="text-xs">${item.label}</span></button>`).join('')}</div></div>
                ${APP.loading ? `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white rounded-2xl p-6 text-center"><i class="fas fa-spinner spinner text-3xl text-blue-500 mb-2"></i><p class="text-gray-600">ƒêang x·ª≠ l√Ω...</p></div></div>` : ''}
                ${APP.notification ? `<div class="fixed top-20 left-4 right-4 max-w-lg mx-auto p-4 rounded-xl shadow-lg flex items-center gap-3 toast ${APP.notification.type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white z-50"><i class="fas ${APP.notification.type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i><span>${APP.notification.message}</span></div>` : ''}
            `;
        };

        // ===================== INIT =====================
        const init = async () => {
            if (!firebaseReady) {
                document.getElementById('app').innerHTML = `<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white rounded-3xl shadow-xl p-8 max-w-md"><div class="text-center mb-6"><div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation-triangle text-yellow-500 text-3xl"></i></div><h2 class="text-xl font-bold text-gray-800">C·∫•u h√¨nh Firebase</h2></div><div class="bg-gray-50 rounded-xl p-4 text-sm text-gray-600 space-y-2"><p>1. T·∫°o project t·∫°i <a href="https://console.firebase.google.com" target="_blank" class="text-blue-500">Firebase Console</a></p><p>2. T·∫°o Firestore Database</p><p>3. Copy c·∫•u h√¨nh v√†o file HTML</p><p>4. M·ªü l·∫°i ·ª©ng d·ª•ng</p></div><div class="mt-4 p-3 bg-green-50 rounded-xl border border-green-200"><p class="text-xs text-green-700"><i class="fas fa-check-circle mr-1"></i>Kh√¥ng c·∫ßn b·∫≠t Authentication!</p></div></div></div>`;
                return;
            }
            try { await initializeAdmin(); const ok = await checkSession(); if (ok) await loadAllData(); } catch (e) { console.error('Init:', e); }
            render();
        };

        init();
    </script>
</body>

</html>